{% extends "base.html" %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="container-fluid" style="padding: 20px;">
    <div class="row" style="display: flex; gap: 20px;">
        
        <div style="flex: 1; min-width: 350px;">
            <div class="card" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ¤– æœºå™¨äººé›†ç¾¤</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="openRegisterModal()" title="æ‰‹åŠ¨æ³¨å†Œæœºå™¨äºº" style="background: #10b981; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 20px;">+</button>
                        <span class="badge" style="background: #e2e8f0; color: #475569;">å…± {{ robots|length }} å°</span>
                    </div>
                </div>

                <div class="robot-list" style="max-height: 400px; overflow-y: auto;">
                    {% for r in robots %}
                    <div class="robot-item" id="robot-card-{{ r.id }}" onclick="selectRobot({{ r.id }}, '{{ r.name }}')" 
                         style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between;">
                            <strong>{{ r.name }}</strong>
                            <span style="color: {{ 'green' if r.status == 'ONLINE' else 'gray' }}">â— {{ r.status }}</span>
                        </div>
                        <p style="font-size: 12px; color: #64748b; margin: 5px 0;">ID: {{ r.device_id }}</p>
                        <p style="font-size: 12px; color: #64748b;">å½“å‰ä½ç½®: <span id="pos-{{ r.id }}">{{ r.current_lat or '0' }}, {{ r.current_lng or '0' }}</span></p>
                        
                        <div style="display: flex; gap: 8px; margin-top: 10px;">
                            <button onclick="event.stopPropagation(); focusRobot({{ r.current_lat }}, {{ r.current_lng }}, '{{ r.name }}')" class="btn-sm">å®šä½</button>
                            <button onclick="event.stopPropagation(); deleteRobot({{ r.id }}, '{{ r.name }}')" style="background: #fee2e2; color: #b91c1c; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">æ³¨é”€</button>
                        </div>
                    </div>
                    {% else %}
                    <p style="text-align: center; color: #94a3b8; padding: 20px;">æš‚æ— æœºå™¨äººï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹ + å·æ‰‹åŠ¨æ³¨å†Œ</p>
                    {% endfor %}
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #f1f5f9;">
                
                <h4 id="control-title">ğŸ•¹ï¸ è¿œç¨‹æ§åˆ¶ (æœªé€‰æ‹©æœºå™¨äºº)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button id="btn-pick" onclick="sendCmd('PICK_TRASH')" disabled style="background: #2563eb; color: white; border: none; padding: 10px; border-radius: 6px; opacity: 0.5; cursor: not-allowed;">æŠ“å–æµ‹è¯•</button>
                    <button id="btn-reset" onclick="sendCmd('RESET')" disabled style="background: #64748b; color: white; border: none; padding: 10px; border-radius: 6px; opacity: 0.5; cursor: not-allowed;">å¤ä½å½’ä½</button>
                    <button id="btn-stop" onclick="sendCmd('STOP')" disabled style="background: #ef4444; color: white; border: none; padding: 10px; border-radius: 6px; grid-column: span 2; opacity: 0.5; cursor: not-allowed;">ç´§æ€¥åœæ­¢</button>
                </div>
            </div>
        </div>

        <div style="flex: 2;">
            <div class="card" style="background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div id="map" style="height: 600px; border-radius: 8px;"></div>
                <div style="margin-top: 10px; font-size: 14px; color: #475569;">
                    <p>ğŸ“ <strong>åœ°ç‚¹è§„åˆ’æç¤ºï¼š</strong> é¦–å…ˆåœ¨å·¦ä¾§ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªæœºå™¨äººï¼Œç„¶ååœ¨åœ°å›¾ä¸Š <strong>åŒå‡»</strong> è®¾ç½®ç›®æ ‡ç‚¹ã€‚</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var selectedRobotId = null;

    // 1. åˆå§‹åŒ–åœ°å›¾
    var map = L.map('map').setView([30.5, 114.3], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    var robotMarker = L.marker([30.5, 114.3]).addTo(map).bindPopup("æœºå™¨äººä½ç½®");
    var targetMarker = L.layerGroup().addTo(map);

    // 2. é€‰æ‹©æœºå™¨äººé€»è¾‘
    function selectRobot(id, name) {
        selectedRobotId = id;
        
        // æ›´æ–° UI æ ·å¼
        document.querySelectorAll('.robot-item').forEach(el => el.style.borderColor = '#e2e8f0');
        document.getElementById('robot-card-' + id).style.borderColor = '#2563eb';
        document.getElementById('robot-card-' + id).style.backgroundColor = '#f8fafc';
        
        // æ¿€æ´»æ§åˆ¶æŒ‰é’®
        document.getElementById('control-title').innerText = `ğŸ•¹ï¸ è¿œç¨‹æ§åˆ¶ (${name})`;
        ['btn-pick', 'btn-reset', 'btn-stop'].forEach(btnId => {
            const btn = document.getElementById(btnId);
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
        });
    }

    // 3. æ‰‹åŠ¨æ³¨å†Œå¼¹çª—
    function openRegisterModal() {
        const device_id = prompt("è¯·è¾“å…¥æœºå™¨äººå”¯ä¸€è®¾å¤‡ ID (éœ€ä¸ Arduino ç«¯ä¸Šä¼  ID ä¸€è‡´):");
        if (!device_id) return;
        const name = prompt("è¯·è¾“å…¥ç»™è¯¥æœºå™¨äººèµ·çš„åç§°:");
        if (!name) return;

        fetch('/api/robot/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ device_id: device_id, name: name })
        }).then(res => res.json()).then(data => {
            if(data.ok) {
                alert("æ³¨å†ŒæˆåŠŸï¼");
                location.reload();
            } else {
                alert("é”™è¯¯: " + data.msg);
            }
        });
    }

    // 4. å®šä½æœºå™¨äºº
    function focusRobot(lat, lng, name) {
        if(lat && lng && lat != 0) {
            map.setView([lat, lng], 16);
            robotMarker.setLatLng([lat, lng]).setPopupContent(name + " åœ¨è¿™é‡Œ").openPopup();
        } else {
            alert("è¯¥æœºå™¨äººå°šæœªä¸ŠæŠ¥æœ‰æ•ˆåæ ‡");
        }
    }

    // 5. åœ°ç‚¹è§„åˆ’ (åŒå‡»åœ°å›¾)
    map.on('dblclick', function(e) {
        if (!selectedRobotId) {
            alert("è¯·å…ˆåœ¨å·¦ä¾§åˆ—è¡¨ä¸­ç‚¹å‡»é€‰æ‹©ä¸€ä¸ªæœºå™¨äººï¼");
            return;
        }

        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if(confirm(`è§„åˆ’æœºå™¨äººå‰å¾€æ­¤åœ°ç‚¹?\nçº¬åº¦: ${lat.toFixed(5)}\nç»åº¦: ${lng.toFixed(5)}`)) {
            targetMarker.clearLayers();
            L.marker([lat, lng], {icon: L.divIcon({className: 'target-icon', html: 'ğŸ¯', iconSize: [30, 30]})}).addTo(targetMarker);

            fetch('/api/robot/navigate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    id: selectedRobotId,
                    lat: lat,
                    lng: lng
                })
            }).then(res => res.json()).then(data => {
                if(data.ok) alert("å¯¼èˆªæŒ‡ä»¤å·²é”å®šï¼Œç­‰å¾…æœºå™¨äººå¿ƒè·³é¢†å–ã€‚");
            });
        }
    });

    // 6. åˆ é™¤æœºå™¨äºº
    function deleteRobot(id, name) {
        if(confirm(`ç¡®å®šè¦æ³¨é”€å¹¶åˆ é™¤æœºå™¨äºº ${name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            fetch(`/api/robot/delete/${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if(data.ok) location.reload();
                else alert("åˆ é™¤å¤±è´¥");
            });
        }
    }

    // 7. è¿œç¨‹æ§åˆ¶æŒ‡ä»¤
    function sendCmd(cmd) {
        if (!selectedRobotId) return;
        
        fetch('/api/robot/control', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id: selectedRobotId, command: cmd })
        }).then(res => res.json()).then(data => {
            if(data.ok) alert("æŒ‡ä»¤ " + cmd + " å·²æ’é˜Ÿä¸‹å‘");
        });
    }
</script>

<style>
    .target-icon { font-size: 24px; text-align: center; }
    .btn-sm { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    .btn-sm:hover { background: #e2e8f0; }
    .robot-item:hover {
        background-color: #f1f5f9;
        transform: translateX(5px);
    }
</style>
{% endblock %}