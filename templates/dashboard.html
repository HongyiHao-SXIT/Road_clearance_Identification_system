{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="card">
  <div class="row" style="justify-content:space-between;">
    <div>
      <h3 style="margin:0;">地图总览</h3>
      <div style="color:#6b7280; font-size:14px; margin-top:6px;">
        任务数：<b>{{ total_tasks }}</b> ｜ 目标数：<b>{{ total_items }}</b>
      </div>
    </div>
    <div class="row">
      <a class="btn2" href="/tasks">任务列表</a>
    </div>
  </div>
</div>

<div style="display:flex; gap:14px; align-items:stretch;">
  <!-- 地图 -->
  <div class="card" style="flex: 3; min-height: 640px;">
    <div id="map" style="width:100%; height: 620px; border-radius:12px;"></div>
  </div>

  <!-- 右侧统计 -->
  <div class="card" style="flex: 1; min-width: 320px;">
    <h3 style="margin-top:0;">垃圾类别统计</h3>
    <div style="max-height: 580px; overflow:auto;">
      <table>
        <thead>
          <tr><th>类别</th><th>数量</th></tr>
        </thead>
        <tbody>
        {% for it in label_counts %}
          <tr>
            <td>{{ it.label }}</td>
            <td><b>{{ it.count }}</b></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // 后端直接把点位数据注入前端（最简单）
  const points = {{ points | tojson }};

  // 默认中心：如果有点就用最新点；没有就用一个默认值（你可以改成你城市中心）
  let center = [39.9042, 116.4074]; // 北京
  if (points.length > 0) {
    center = [points[0].lat, points[0].lon];
  }

  const map = L.map('map').setView(center, 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  // markers
  points.forEach(p => {
    const popup = `
      <div style="font-size:14px;">
        <div><b>Task #${p.task_id}</b></div>
        <div>Status: ${p.status}</div>
        <div>Location: ${p.location ?? "-"}</div>
        <div>Time: ${p.created_at}</div>
        <div style="margin-top:8px;">
          <a href="/tasks/${p.task_id}">打开任务详情</a>
        </div>
      </div>
    `;
    L.marker([p.lat, p.lon]).addTo(map).bindPopup(popup);
  });
</script>
{% endblock %}
