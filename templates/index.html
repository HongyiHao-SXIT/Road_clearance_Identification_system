{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="dashboard-container">
    <div class="header-section">
        <h2>ğŸŒ TrashDet åƒåœ¾æ£€æµ‹æŒ‡æŒ¥ä¸­å¿ƒ</h2>
        <div class="action-btns">
            <a href="/upload" class="btn btn-primary">ğŸ“¸ æ‰‹åŠ¨ä¸Šä¼ ç»ˆç«¯</a>
            <a href="/result" class="btn">ğŸ“‹ æ£€æµ‹ç»“æœåˆ—è¡¨</a>
        </div>
    </div>

    <div class="map-card">
        <div id="map" style="height: 450px; border-radius: 15px;"></div>
    </div>

    <div class="stats-grid">
        <div class="chart-box">
            <h3>ğŸ“Š åƒåœ¾ç§ç±»æ¯”ä¾‹</h3>
            <div id="pieChart" style="height: 300px;"></div>
        </div>
        <div class="chart-box">
            <h3>ğŸ“ˆ è¿‘æœŸæ£€æµ‹è¶‹åŠ¿</h3>
            <div id="lineChart" style="height: 300px;"></div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .map-card {
        background: white;
        padding: 15px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .chart-box {
        background: white;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    h3 {
        margin-bottom: 15px;
        font-size: 16px;
        color: #475569;
    }
</style>

<script>
    // 1. åˆå§‹åŒ–åœ°å›¾ (é»˜è®¤å®šä½)
    const map = L.map('map').setView([31.2304, 121.4737], 11); // ä»¥ç¤ºä¾‹åæ ‡ä¸ºä¾‹
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // 2. åŠ è½½ç»Ÿè®¡æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨ä¸åœ°å›¾ç‚¹
    fetch('/api/stats/summary')
        .then(res => res.json())
        .then(data => {
            if (!data.ok) return;

            // --- ç»˜åˆ¶é¥¼å›¾ ---
            const pieChart = echarts.init(document.getElementById('pieChart'));
            pieChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: ['40%', '70%'],
                    data: data.pie_data
                }]
            });

            // --- ç»˜åˆ¶æŠ˜çº¿å›¾ ---
            const lineChart = echarts.init(document.getElementById('lineChart'));
            lineChart.setOption({
                xAxis: { type: 'category', data: data.line_data.labels },
                yAxis: { type: 'value' },
                series: [{ data: data.line_data.values, type: 'line', smooth: true }]
            });

            // --- 3. æ¸²æŸ“åŠ¨æ€åœ°å›¾ç‚¹ ---
            if (data.locations && data.locations.length > 0) {
                data.locations.forEach(loc => {
                    L.circleMarker([loc.lat, loc.lng], { color: '#ef4444', radius: 8 })
                        .addTo(map)
                        .bindPopup(loc.label);
                });
                // è‡ªåŠ¨è°ƒæ•´è§†é‡åˆ°ç¬¬ä¸€ä¸ªç‚¹
                map.setView([data.locations[0].lat, data.locations[0].lng], 12);
            }
        });
</script>
{% endblock %}