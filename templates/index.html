{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

<div class="dashboard-container">
    <div class="header-section">
        <h2>ğŸŒ TrashDet åƒåœ¾æ£€æµ‹æŒ‡æŒ¥ä¸­å¿ƒ</h2>
        <div class="action-btns">
            <a href="/upload" class="btn btn-primary">ğŸ“¸ æ‰‹åŠ¨ä¸Šä¼ ç»ˆç«¯</a>
            <a href="/result" class="btn">ğŸ“‹ æ£€æµ‹ç»“æœåˆ—è¡¨</a>
        </div>
    </div>

    <div class="map-card">
        <div id="map" style="height: 450px; border-radius: 15px;"></div>
    </div>

    <div class="stats-grid">
        <div class="chart-box">
            <h3>ğŸ“Š åƒåœ¾ç§ç±»æ¯”ä¾‹</h3>
            <div id="pieChart" style="height: 300px;"></div>
        </div>
        <div class="chart-box">
            <h3>ğŸ“ˆ è¿‘æœŸæ£€æµ‹è¶‹åŠ¿</h3>
            <div id="lineChart" style="height: 300px;"></div>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .map-card {
        background: white;
        padding: 15px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .chart-box {
        background: white;
        padding: 20px;  
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    h3 {
        margin-bottom: 15px;
        font-size: 16px;
        color: #475569;
    }
</style>

<script>
    // 1. åˆå§‹åŒ–åœ°å›¾
    const map = L.map('map').setView([30.0, 110.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function loadDashboardData() {
        fetch('/api/stats/summary')
            .then(res => res.json())
            .then(data => {
                if (!data.ok) return;

                const pieChart = echarts.init(document.getElementById('pieChart'));
                pieChart.setOption({
                    tooltip: { trigger: 'item' },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        data: data.pie_data
                    }]
                });

                const lineChart = echarts.init(document.getElementById('lineChart'));
                lineChart.setOption({
                    xAxis: { type: 'category', data: data.line_data.labels },
                    yAxis: { type: 'value' },
                    series: [{ data: data.line_data.values, type: 'line', smooth: true }]
                });

                if (data.locations && data.locations.length > 0) {
                    data.locations.forEach(loc => {
                        const marker = L.marker([loc.lat, loc.lng]).addTo(map);

                        const cardHtml = `
                            <div class="map-card" style="width: 200px; padding: 5px;">
                                <h4 style="margin: 0 0 8px; color: #2563eb; border-bottom: 1px solid #eee;">ä»»åŠ¡ #${loc.id}</h4>
                                <p style="font-size: 13px; margin: 4px 0;">
                                    <b>è¯†åˆ«ç»“æœ:</b> <span style="color: #ef4444;">${loc.trash_types || 'æœªæ£€æµ‹åˆ°'}</span>
                                </p>
                                <hr style="border: 0; border-top: 1px solid #eee; margin: 8px 0;">
                                <p style="font-size: 11px; color: #666;">åæ ‡: ${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</p>
                            </div>
                        `;

                        // ç»‘å®š Popup å¹¶è®¾ç½®åç§»é‡é˜²æ­¢é®æŒ¡ç‚¹
                        marker.bindPopup(cardHtml, {
                            closeButton: false,
                            offset: L.point(0, -15)
                        });

                        // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºï¼Œç§»å¼€éšè—
                        marker.on('mouseover', function (e) {
                            this.openPopup();
                        });
                        marker.on('mouseout', function (e) {
                            this.closePopup();
                        });
                    });

                    // è‡ªåŠ¨ç¼©æ”¾åˆ°ç¬¬ä¸€ä¸ªç‚¹
                    map.setView([data.locations[0].lat, data.locations[0].lng], 10);
                }
            })
            .catch(err => console.error("åŠ è½½æ•°æ®å¤±è´¥:", err));
    }

    loadDashboardData();
</script>
{% endblock %}